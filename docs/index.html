<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		
		<meta name="description" content="Going declarative with helmfile !">
		<meta name="author" content="Antonin Brugnot">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Helmfile</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h3>Going declarative with helmfile!</h3>
					<p>
						<small>Antonin Brugnot</small>
					</p>
				</section>
				<section>Slide 2</section>
				<section data-auto-animate>
					<h2 data-id="code-title">Comme sur les tutos</h2>
					<pre data-id="code-animation"><code class="hljs python" data-trim data-line-numbers="|1-2|4|6-15"><script type="text/template">
						helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
						helm repo add grafana https://grafana.github.io/helm-charts
                        
						helm repo update
                        
						helm install prometheus prometheus-community/prometheus \
						--set alertmanager.enabled=false \
						--namespace monitoring \
						--version 25.20.1

						helm install grafana grafana/grafana \
						--set persistence.enabled=true \
						--set adminPassword=strongpassword \
						--namespace monitoring \
						--version 7.3.9
					</script></code></pre>
				</section>
				<section data-auto-animate>
					<h2 data-id="code-title">On script</h2>
					<pre data-id="code-animation"><code class="hljs bash" data-trim data-line-numbers="1|3-7|9-14|16-21"><script type="text/template">
						# /bin/sh

						prometheus_version="25.20.1"
						grafana_version="7.3.9"
						namespace="monitoring"
						prometheus_release_name=prometheus
						grafana_release_name=grafana
						
						echo "Install Prometheus version $prometheus_version in namespace $namespace"
						
						helm install $prometheus_release_name prometheus-community/prometheus \
						-f ./prometheus/values.yaml \
						--namespace $namespace \
						--version $prometheus_version

						echo "Install Grafana version $grafana_version in namespace $namespace"
						
						helm install $grafana_release_name grafana/grafana \
						-f ./grafana/values.yaml \
						--namespace $namespace \
						--version $grafana_version
					</script></code></pre>
				</section>
				<section data-auto-animate>
					<h2 data-id="code-title">values.yaml</h2>
					<pre data-id="code-animation"><code class="hljs yaml" data-trim data-line-numbers><script type="text/template">
						## Enable persistence using Persistent Volume Claims
						## ref: http://kubernetes.io/docs/user-guide/persistent-volumes/
						##
						persistence:
						  enabled: true
						  
						# Administrator credentials when not using an existing secret (see below)
						adminPassword: strongpassword
					</script></code></pre>
				</section>				
				<section data-auto-animate>
					<h2 data-id="code-title">Helmfile</h2>
					<pre data-id="code-animation"><code class="hljs yaml" data-trim data-line-numbers="|1-5|7|8-11,15-17|12-13,18-19|20"><script type="text/template">
						repositories:
						  - name: prometheus-community
						    url: https://prometheus-community.github.io/helm-charts
						  - name: grafana
						    url: https://grafana.github.io/helm-charts
						  
						releases:
						  - name: prometheus
						    namespace: monitoring
						    chart: prometheus-community/prometheus
						    version: "25.20.1"
						    values:
							  - "./prometheus/values.yaml"
						  - name: grafana
						    namespace: monitoring
						    chart: grafana/grafana
						    version: "7.3.9"
						    values:
							  - "./grafana/values.yaml" 
							  - "./grafana/secrets.yaml"
					</script></code></pre>
				</section>
				<section data-auto-animate>
					<h2 data-id="code-title">helmfile cli</h2>
					<pre data-id="code-animation"><code class="hljs python" data-trim data-line-numbers="|1|3|5"><script type="text/template">
						helmfile init

						helmfile apply

						helmfile diff
					</script></code></pre>
				</section>
				<section>
					<section>
						<h2>Et les secrets ?</h2>
						<ul>
							<li><a href="https://github.com/jkroepke/helm-secrets">helm-secrets</a></li>
							<li>sops / val</li>
							<li>gpg</li>
							<li>Chiffrement dans les sources</li>
							<li>Déchiffrement à l'installation</li>
						</ul>
					</section>
					<section data-auto-animate>
						<h2 data-id="code-title">Generation clé gpg</h2>
						<pre data-id="code-animation"><code class="hljs python" data-trim data-line-numbers><script type="text/template">
							gpg --full-generate-key
							
							gpg --list-secret-keys --keyid-format=long
						</script></code></pre>
					</section>
					<section data-auto-animate>
						<h2 data-id="code-title">.sops.yaml</h2>
						<pre data-id="code-animation"><code class="hljs yaml" data-trim data-line-numbers><script type="text/template">
							creation_rules:
							- pgp: "19C61C7151B4DFB21ADBBF43863F50B4F27E48F8"
						</script></code></pre>
					</section>
					<section data-auto-animate>
						<h2 data-id="code-title">Chiffrement</h2>
						<pre data-id="code-animation"><code class="hljs python" data-trim data-line-numbers><script type="text/template">
							helm secrets encrypt ./grafana/secrets-clear.yaml \
							> ./grafana/secrets.yaml
						</script></code></pre>
					</section>
					<section data-auto-animate>
						<h2 data-id="code-title">secrets.yaml</h2>
						<pre data-id="code-animation"><code class="hljs yaml" data-trim data-line-numbers="|1|8|10-28"><script type="text/template">
							adminPassword: ENC[AES256_GCM,data:wiPsiKe/1W1DBUmmvSQ=,iv:boZa+cd3/+nYn0YFAVjQHAb2B8MqloTY2KIZs9VCINo=,tag:BzvbSWbeZdaCAIRnmUldFQ==,type:str]
							sops:
								kms: []
								gcp_kms: []
								azure_kv: []
								hc_vault: []
								age: []
								lastmodified: "2024-05-13T20:31:28Z"
								mac: ENC[AES256_GCM,data:XsCM7+RGQfoJpJABOFXv93KchzwO3o/3ocJI0E87+1vFRJ46y/GfKOrEoJL+kBfxiyRIiJX30xTnrRAhl289styLuKob+PZnbqRb8pvbZI0eRMYrJOqyyqRgtSXnfsU9wqtwWgsKpfzG+K6Gt337QJ3fQ7eCoNs9bQdstHnaqYI=,iv:l4DT4PS8kaVIU/ybiTBA0xLpQBu/WUjo6vy5/F2HQHo=,tag:IiPV8LVFKmO6IFTKlsVOCw==,type:str]
								pgp:
									- created_at: "2024-05-13T20:31:28Z"
									  enc: |-
										-----BEGIN PGP MESSAGE-----
							
										hQGMA91kvT7TiSGcAQv/f0K9SCxjRITLLnYzKTdGfghTYDPJjaulYj2c9Iyn2Xo0
										rCbtxd0Pa/2SOTKUCa361yToBb51HrM1F3ewgZavHKyoe/prOJhVvbyzu4aHeSzb
										1hp/7ABzh15wT+2HG92cnf7K070RgbayF+G56D+3fq05NQBJX8mRgo4TqVb/L1xy
										+QbbrUD1Kppj2LNeel0ftRACQiIVgDjHG2AHBW7kAwfZqPDaq2k3HlivyUgOezfr
										Iaz21nFrJSa4s/s/TEBYVHWqlAz8KbR0VS8VdC5i/BTxMNbNBoerOj1aYZMrFEF4
										Mur20lJvT3VZL4I2lMtifsmfHAi7ed7a0DGi6VPtADweLlprm9+O0VfI4QqOz6nf
										f38gxJgkwC9tEiCse+qlRhMVznceVbIjwQCZjFIet1t6P8/diiC2aZQb+Onp1H+a
										uBPw7+UbgtB2cyxheP24ZeiGc/4A5LjO6j6UHi/Gl16yhjvOecqZr6OQQkGtjROt
										KDtUkYPzu4akjTAZLpOh0l4BcPGkUqr+6xIeYVAWT8tW6ycuINORKyYZ/BUbJ/U+
										nrg+0riWL17bYOKd/2XEL6K3te3JysDLRjK2TRsK6jGIZZxhsyduBIWS8jJcWjs1
										/XGhHnpDkx04yuvkHGVi
										=p1LO
										-----END PGP MESSAGE-----
									  fp: 19C61C7151B4DFB21ADBBF43863F50B4F27E48F8
								unencrypted_suffix: _unencrypted
								version: 3.8.1
						</script></code></pre>
					</section>
			    </section>	
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [RevealNotes, RevealMarkdown, RevealHighlight ]
			});
		</script>
	</body>
</html>
